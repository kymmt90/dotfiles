#!/usr/bin/env bash

set -uo pipefail

xcode-select --install 2>/dev/null

MITAMAE_VERSION="1.14.4"
MITAMAE_BIN=mitamae-aarch64-darwin

if [ -e bin/$MITAMAE_BIN ]; then
  MITAMAE_VERSION_STDOUT=$(bin/$MITAMAE_BIN version)
  VERSION_REGEX="([0-9]+\.[0-9]+\.[0-9]+)"

  if [[ $MITAMAE_VERSION_STDOUT =~ $VERSION_REGEX ]]; then
    CURRENT_MITAMAE_VERSION=${BASH_REMATCH[1]}
  fi
fi

if [ ! -e bin/$MITAMAE_BIN ] || [ $MITAMAE_VERSION != $CURRENT_MITAMAE_VERSION ]; then
  (cd bin; curl -sSL https://github.com/itamae-kitchen/mitamae/releases/download/v${MITAMAE_VERSION}/${MITAMAE_BIN}.tar.gz | tar xvz)
fi

while getopts ":r:" opt; do
  case $opt in
    r)
      if [[ ! "$OPTARG" =~ ^(work|personal)$ ]]; then
        echo "error: invalid role '$OPTARG'" >&2
        exit 1
      fi
      ROLE=$OPTARG
      ;;
  esac
done

bin/$MITAMAE_BIN local roles/${ROLE:-work}.rb
