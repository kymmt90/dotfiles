#!/usr/bin/env bash

set -uo pipefail

MITAMAE_VERSION="1.14.4"
MITAMAE_BIN=mitamae-aarch64-darwin

if [ -e bin/$MITAMAE_BIN ]; then
  MITAMAE_VERSION_STDOUT=$(bin/$MITAMAE_BIN version)
  VERSION_REGEX="([0-9]+\.[0-9]+\.[0-9]+)"

  if [[ $MITAMAE_VERSION_STDOUT =~ $VERSION_REGEX ]]; then
    CURRENT_MITAMAE_VERSION=${BASH_REMATCH[1]}
  fi
fi

if [ ! -e bin/$MITAMAE_BIN ] || [ $MITAMAE_VERSION != $CURRENT_MITAMAE_VERSION ]; then
  (cd bin; curl -sSL https://github.com/itamae-kitchen/mitamae/releases/download/v${MITAMAE_VERSION}/${MITAMAE_BIN}.tar.gz | tar xvz)
fi
bin/$MITAMAE_BIN local recipe.rb
